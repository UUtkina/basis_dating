Фреймворк для агрегации в MongoDB моделирует концепцию обработку данных с помощью pipeline.
 Документы вводят многоэтапный конвейер, который преобразует документы в агрегированный результат.


В MongoDB для агрегации используется метод aggregate(). Данный метод имеет следующий синтаксис:

db.ИМЯ_КОЛЛЕКЦИИ.aggregate(ОПЕРАЦИЯ_АГРЕГАЦИИ)

Допустим, что нам необходимо вычислить общий баланс всех пользователей в коллекции. Для этого мы можем использовать следующий запрос:

db.users.aggregate( [ {$group :{ _id : "Total_sum", total_balance: { $sum : "$balance" }}} ] )

--{
    "_id" : "Total_sum",
    "total_balance" : 702.4302
}

ОПЕРАЦИИ_АГРЕГАЦИИ
$project - Используется для выбора некоторых специальных полей из коллекции.
$match - Операция фильтрации, которая может уменьшить количество документов, которые передаются для ввода в следующий этап.
$group - Непосредственно, сама агрегация
$sort - Сортирует документы
$skip - С помощью данной команды мы можем проигнорировать список документов в имеющемся множестве.
$limit - Ограничивает количество документов для вывода на количество, переданное методу, начиная, с текущей позиции.
$unwind - Используется для “разматывания” документов, который используют массивы.

Список всех операторов которые могут быть использованы в $group

$sum — Возвращает сумму всех численных полей.
$avg — Рассчитывает среднее значение между числовыми полями.
$min — получит минимальное значение из числовых полей
$max — Получить максимальное значение из числовых полей
$push — Помещает значение поля в результирующий массив
$addToSet — Вставляет значение в массив в результирующем документе, но не создаёт дубликаты.
$first — Получает только первый документ из сгрупированных, обычно используется с сортировкой.
$last — Получает последний документ